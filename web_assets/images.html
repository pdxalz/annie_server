<!DOCTYPE html>
<html>
<head>
    <title>Image Viewer</title>
    <link rel="stylesheet" href="/web_assets/styles.css">
    <script>
        let images = [];
        let index = 0;
        const password = 'wingersrock';
        let takeImageConfirmed = false;

        async function fetchImages() {
            const response = await fetch('/list_images');
            const data = await response.json();
            images = data.files;
            displayImage();
        }

        function displayImage() {
            const img = document.getElementById('image');
            img.src = '/images/' + images[index];

            const dateStr = images[index].replace('.jpg', '');
            const month = dateStr.slice(0, 2);
            const day = dateStr.slice(3, 5);
            const hour = dateStr.slice(6, 8);
            const minute = dateStr.slice(9, 11);
            const formattedDateStr = `${month}/${day}   ${hour}:${minute}`;
            document.getElementById('date').textContent = formattedDateStr;
        }

        function nextImage() {
            if (index < images.length - 1) {
                index++;
                displayImage();
            }
        }

        function previousImage() {
            if (index > 0) {
                index--;
                displayImage();
            }
        }

        async function takeImage(size) {
            if (!takeImageConfirmed) {
                const userPassword = prompt('Please enter the password to take an image:');
                if (userPassword !== password) {
                    alert('Incorrect password');
                    return;
                }
                takeImageConfirmed = true;
            }
            const response = await fetch('/take_image?size=' + size);
            const data = await response.json();
            // alert('Image capture command sent');
            await fetchImages();  // Fetch the updated list of images
            index = 0;
            displayImage();
        }

        async function deleteImage() {
            if (!takeImageConfirmed) {
                const userPassword = prompt('Please enter the password to delete the image:');
                if (userPassword !== password) {
                    alert('Incorrect password');
                    return;
                }
                takeImageConfirmed = true;
            }
            const response = await fetch('/delete_image?filename=' + images[index]);
            const data = await response.json();
            // alert('Deleted: ' + data.deleted);
            images.splice(index, 1);
            if (images.length === 0) {
                document.getElementById('image').src = '';
            } else if (index >= images.length) {
                index = images.length - 1;
                displayImage();
            } else {
                displayImage();
            }
        }

        window.onload = fetchImages;
    </script>
</head>
<body>
    <div id="controls">
        <button onclick="previousImage()">Newer</button>
        <button onclick="nextImage()">Older</button>
    </div>
    <div id="date"></div>
    <div id="image-container">
        <img id="image" src="">
        <div id="actions">
            <button onclick="takeImage('small')">Take Small Image</button>
            <button onclick="takeImage('medium')">Take Medium Image</button>
            <button onclick="takeImage('large')">Take Large Image</button>
            <button onclick="deleteImage()">Delete</button>
        </div>
    </div>
</body>
</html>